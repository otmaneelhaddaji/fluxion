define(["jquery","knockout","config/config","service","underscore","config/menu","logout","opmode/opmode","status/statusBar"],function(e,n,t,o,i,r,a,u,s){function c(){return setInterval(function(){if(!o.getStatusInfo().isLoggedIn)return void m();lastLoginStatus=o.getStatusInfo().isLoggedIn?"1":"0"},1e3)}function l(){function i(){var e=o.getLoginData(),n=o.getLoginStatus(),t=g(n,e);t==d.LOADING?addTimeout(i,500):(N.pageState(t),N.pinNumber(e.pinnumber),N.pukNumber(e.puknumber)),l()}function l(){setTimeout(function(){var n=e("#txtPwd:visible"),t=e("#txtPIN:visible"),o=e("#txtPUK:visible");n.length>0?n.focus():t.length>0?t.focus():o.length>0&&o.focus()},100)}function g(e,n){return t.LOGIN_THEN_CHECK_PIN?_(e,n):m(e,n)}function _(n,o){if("loggedIn"==n.status)return"modem_waitpin"==i?d.WAIT_PIN:"modem_waitpuk"!=i&&0!=o.pinnumber||0==o.puknumber?0!=o.puknumber&&"modem_sim_destroy"!=i||"modem_sim_undetected"==i||"modem_undetected"==i?d.LOGGEDIN:d.PUK_LOCKED:d.WAIT_PUK;var i=o.modem_main_state;return-1!=e.inArray(i,t.TEMPORARY_MODEM_MAIN_STATE)?d.LOADING:d.LOGIN}function m(n,o){if("loggedIn"==n.status)return d.LOGGEDIN;var i=o.modem_main_state;return-1!=e.inArray(i,t.TEMPORARY_MODEM_MAIN_STATE)?d.LOADING:"modem_waitpin"==i?d.WAIT_PIN:"modem_waitpuk"!=i&&0!=o.pinnumber||0==o.puknumber?0!=o.puknumber&&"modem_sim_destroy"!=i||"modem_sim_undetected"==i||"modem_undetected"==i?d.LOGIN:d.PUK_LOCKED:d.WAIT_PUK}var N=this;N.adImages=t.AD_IMAGES;var L=o.getLoginData(),P=o.getLoginStatus();N.password=n.observable(),N.PIN=n.observable(),N.PUK=n.observable(),N.newPIN=n.observable(),N.confirmPIN=n.observable(),N.pinNumber=n.observable(L.pinnumber),N.pukNumber=n.observable(L.puknumber),N.showEntrance=n.observable(!1),N.sharePathInvalid=n.observable(!1),N.loginCount=n.observable(0),N.loginSecuritySupport=n.observable(t.LOGIN_SECURITY_SUPPORT),N.leftSeconds=n.observable(0),N.accountLocked=n.computed(function(){return N.loginCount()==t.MAX_LOGIN_COUNT&&"-1"!=N.leftSeconds()}),N.uiLoginTimer=n.observable(300),N.leftUnlockTime=n.computed(function(){N.leftSeconds();var e=transSecond2Time(N.uiLoginTimer());return e.substring(e.indexOf(":")+1,e.length)}),s.setRedirectTips(!1),t.SD_CARD_SUPPORT&&o.getSDConfiguration({},function(e){N.showEntrance("1"==e.sd_status&&"1"==e.share_status&&"0"==e.sd_mode),N.showEntrance()&&o.checkFileExists({path:e.share_file},function(e){"exist"==e.status?N.sharePathInvalid(!1):N.sharePathInvalid(!0)})});var p=g(P,L);N.pageState=n.observable(p),p==d.LOADING&&addTimeout(i,500),l(),N.login=function(){if(t.LOGIN_SECURITY_SUPPORT&&N.accountLocked())return showAlert("password_error_account_lock_time",function(){l()}),!1;N.pageState(d.LOADING),N.checkLoginData(function(){setTimeout(function(){N.loginAct()},t.LOGIN_SECURITY_SUPPORT&&N.accountLocked()?1e3*N.uiLoginTimer():0)})},N.loginAct=function(){window.clearInterval(f),o.login({password:N.password()},function(e){if(setTimeout(function(){f=c()},1300),e.result){if(N.pageState(d.LOGGEDIN),t.LOGIN_SECURITY_SUPPORT&&(N.loginCount(0),N.uiLoginTimer(300),clearInterval(I)),"FOTA"==t.UPGRADE_TYPE||"OTA"==t.UPGRADE_TYPE){if(o.getNewVersionState().hasNewVersion)t.HAS_OTA_NEW_VERSION=!0;else{var n={};n=o.getCurrentUpgradeState(),"upgrade_pack_redownload"==n.current_upgrade_state&&(t.HAS_OTA_NEW_VERSION=!0)}}window.location.hash="#home",r.rebuild(),a.init(),u.init()}else N.password(""),t.LOGIN_SECURITY_SUPPORT?N.checkLoginData(function(){N.loginCount()==t.MAX_LOGIN_COUNT?(showAlert("password_error_five_times",function(){l()}),N.startLoginLockInterval()):showAlert({msg:"password_error_left",params:[t.MAX_LOGIN_COUNT-N.loginCount()]},function(){l()})}):showAlert("password_error",function(){l()}),N.pageState(d.LOGIN)})},N.startLoginLockInterval=function(){I=setInterval(function(){N.uiLoginTimer()<=0&&(N.loginCount(0),clearInterval(I)),N.uiLoginTimer(N.uiLoginTimer()>0?N.uiLoginTimer()-1:0)},1e3)},N.checkLoginData=function(n){o.getLoginData({},function(o){var i=parseInt(o.psw_fail_num_str,10);N.loginCount(t.MAX_LOGIN_COUNT-i),N.leftSeconds(o.login_lock_time),N.uiLoginTimer(o.login_lock_time),e.isFunction(n)?n():N.loginCount()==t.MAX_LOGIN_COUNT&&N.startLoginLockInterval()})},N.checkLoginData(),N.enterPIN=function(){N.pageState(d.LOADING);var e=N.PIN();o.enterPIN({PinNumber:e},function(e){e.result?i():(showAlert("pin_error",function(){i()}),N.PIN(""))})},N.enterPUK=function(){N.pageState(d.LOADING);var e=N.newPIN(),n=(N.confirmPIN(),{});n.PinNumber=e,n.PUKNumber=N.PUK(),o.enterPUK(n,function(e){e.result?i():(showAlert("puk_error",function(){i()}),N.PUK(""),N.newPIN(""),N.confirmPIN(""))})}}function g(){if("#login"!=window.location.hash)return!1;var n=e("#mainContainer"),t=e(window).height(),o=e("#topStatus").outerHeight(!0),i=e("#footer").outerHeight(!0);if(t-o-n.height()-i>0){var r=t-o-i-5;n.height(r+"px");var a=e("#container"),u=(r-a.height())/2;a.css({"margin-top":u+"px","margin-bottom":u+"px"})}}function _(){if(o.getStatusInfo().isLoggedIn)return void(window.location.hash="#home");var t=e("#container")[0];n.cleanNode(t);var i=new l;n.applyBindings(i,t),g();var r;e(window).bind("resize",function(){e.browser.msie?r||(r=setTimeout(function(){g(),r=null},50)):g()}),e("#frmLogin").validate({submitHandler:function(){i.login()},rules:{txtPwd:"login_password_length_check"}}),e("#frmPIN").validate({submitHandler:function(){i.enterPIN()},rules:{txtPIN:"pin_check"}}),e("#frmPUK").validate({submitHandler:function(){i.enterPUK()},rules:{txtNewPIN:"pin_check",txtConfirmPIN:{equalTo:"#txtNewPIN"},txtPUK:"puk_check"}})}function m(){if(window.location.hash!=t.defaultRoute&&-1==i.indexOf(t.GUEST_HASH,window.location.hash))if(manualLogout||"1"!=lastLoginStatus){if("UNREAL"==lastLoginStatus)return;window.location="index.html"}else manualLogout=!1,lastLoginStatus="UNREAL",showAlert("need_login_again",function(){window.location="index.html"})}var d={LOGIN:0,WAIT_PIN:1,WAIT_PUK:2,PUK_LOCKED:3,LOGGEDIN:4,LOADING:5},f=c(),I=0;return{init:_,gotoLogin:m}});
//# sourceMappingURL=../sourcemaps/login.js.map
